name: Publish IoTSmartSysCore to PlatformIO

on:
  push:
    tags:
      - 'v*'   # dispara quando você der push em tags tipo v0.1.0, v1.0.0 etc.

  workflow_dispatch:  # opcional: permite rodar manualmente

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install PlatformIO CLI
        run: |
          pip install -U platformio

      - name: Read IoTSmartSysCore version
        id: read_version
        run: |
          VERSION=$(python - << 'EOF'
          import json
          with open("library.json") as f:
              print(json.load(f)["version"])
          EOF
          )
          echo "core_version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Detected IoTSmartSysCore version: $VERSION"

      - name: Generate IoTSmartSysCoreVersion header
        env:
          CORE_VERSION: ${{ steps.read_version.outputs.core_version }}
        run: |
          VERSION="$CORE_VERSION"

          # Assume semantic versioning: MAJOR.MINOR.PATCH
          MAJOR=$(echo "$VERSION" | cut -d. -f1)
          MINOR=$(echo "$VERSION" | cut -d. -f2)
          PATCH=$(echo "$VERSION" | cut -d. -f3)

          mkdir -p src
          cat > src/IoTSmartSysCoreVersion.h <<EOF
          #pragma once

          #define IOTSMARTSYSCORE_VERSION           "${VERSION}"
          #define IOTSMARTSYSCORE_VERSION_MAJOR     ${MAJOR}
          #define IOTSMARTSYSCORE_VERSION_MINOR     ${MINOR}
          #define IOTSMARTSYSCORE_VERSION_PATCH     ${PATCH}
          EOF

          echo "Generated src/IoTSmartSysCoreVersion.h:"
          cat src/IoTSmartSysCoreVersion.h

      - name: Publish package to PlatformIO Registry
        env:
          PLATFORMIO_AUTH_TOKEN: ${{ secrets.PLATFORMIO_AUTH_TOKEN }}
        run: |
          echo "Publishing IoTSmartSysCore version from library.json..."
          pio pkg publish --no-interactive

      - name: Trigger firmware workflows (repository_dispatch)
        env:
          GH_TOKEN: ${{ secrets.ORG_REPO_DISPATCH_TOKEN }}
          CORE_VERSION: ${{ steps.read_version.outputs.core_version }}
        run: |
          if [ -z "$GH_TOKEN" ]; then
            echo "ORG_REPO_DISPATCH_TOKEN not set; skipping firmware notifications."
            exit 0
          fi

          repos=(
            "iotsmartsys/SmartHome-Firmwares"
            # Adicione aqui outros repositórios de firmware quando quiser que sejam notificados
          )

          for repo in "${repos[@]}"; do
            echo "Dispatching event to $repo (IoTSmartSysCore v$CORE_VERSION)..."
            curl -X POST \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer $GH_TOKEN" \
              https://api.github.com/repos/$repo/dispatches \
              -d "{\"event_type\":\"iotsmartsyscore-updated\",\"client_payload\":{\"core_version\":\"$CORE_VERSION\"}}"
          done